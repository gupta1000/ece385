#define ROWS 20
#define COLS 10
#define REFRESH 500
#define REFRESH_KB 100

#define RED 1
#define BLUE 2
#define GREEN 3
#define YELLOW 4

#define UP_KEY 0x52
#define DOWN_KEY 0x51
#define LEFT_KEY 0x50
#define RIGHT_KEY 0x4f
#define SPACE_KEY 0x2c

volatile int kb_char;
volatile int game;
volatile time_t now;

volatile unsigned char * TETRIS_PTR = (unsigned char *) 0x01000;

int kb_buf[1000];
char board[ROWS][COLS];

int pp, px, py, pr;

int is_valid(int p, int r, int x, int y);

int move_down();

int move_left();

int move_right();

void drop();

void rotate();

void next_piece();

void commit2board(int p, int r, int x, int y);

void draw2hardware();

int pieces[7][4][4][4] = {
  // tall
  {
    {
      { 0x00, 0x11, 0x00, 0x00 },
      { 0x00, 0x11, 0x00, 0x00 },
      { 0x00, 0x11, 0x00, 0x00 },
      { 0x00, 0x11, 0x00, 0x00 },
    },
    {
      { 0x00, 0x00, 0x00, 0x00 },
      { 0x11, 0x11, 0x11, 0x11 },
      { 0x00, 0x00, 0x00, 0x00 },
      { 0x00, 0x00, 0x00, 0x00 },
    },
    {
      { 0x00, 0x11, 0x00, 0x00 },
      { 0x00, 0x11, 0x00, 0x00 },
      { 0x00, 0x11, 0x00, 0x00 },
      { 0x00, 0x11, 0x00, 0x00 },
    },
    {
      { 0x00, 0x00, 0x00, 0x00 },
      { 0x11, 0x11, 0x11, 0x11 },
      { 0x00, 0x00, 0x00, 0x00 },
      { 0x00, 0x00, 0x00, 0x00 },
    },
  },
  // square
  {
    {
      { 0x00, 0x12, 0x12, 0x00 },
      { 0x00, 0x12, 0x12, 0x00 },
      { 0x00, 0x00, 0x00, 0x00 },
      { 0x00, 0x00, 0x00, 0x00 },
    },
    {
      { 0x00, 0x12, 0x12, 0x00 },
      { 0x00, 0x12, 0x12, 0x00 },
      { 0x00, 0x00, 0x00, 0x00 },
      { 0x00, 0x00, 0x00, 0x00 },
    },
    {
      { 0x00, 0x12, 0x12, 0x00 },
      { 0x00, 0x12, 0x12, 0x00 },
      { 0x00, 0x00, 0x00, 0x00 },
      { 0x00, 0x00, 0x00, 0x00 },
    },
    {
      { 0x00, 0x12, 0x12, 0x00 },
      { 0x00, 0x12, 0x12, 0x00 },
      { 0x00, 0x00, 0x00, 0x00 },
      { 0x00, 0x00, 0x00, 0x00 },
    },
  },
  // L
  {
    {
      { 0x00, 0x13, 0x00, 0x00 },
      { 0x00, 0x13, 0x00, 0x00 },
      { 0x00, 0x13, 0x13, 0x00 },
      { 0x00, 0x00, 0x00, 0x00 },
    },
    {
      { 0x13, 0x13, 0x13, 0x00 },
      { 0x13, 0x00, 0x00, 0x00 },
      { 0x00, 0x00, 0x00, 0x00 },
      { 0x00, 0x00, 0x00, 0x00 },
    },
    {
      { 0x00, 0x13, 0x13, 0x00 },
      { 0x00, 0x00, 0x13, 0x00 },
      { 0x00, 0x00, 0x13, 0x00 },
      { 0x00, 0x00, 0x00, 0x00 },
    },
    {
      { 0x00, 0x00, 0x13, 0x00 },
      { 0x13, 0x13, 0x13, 0x00 },
      { 0x00, 0x00, 0x00, 0x00 },
      { 0x00, 0x00, 0x00, 0x00 },
    },
  },
  // backwards L
  {
    {
      { 0x00, 0x00, 0x14, 0x00 },
      { 0x00, 0x00, 0x14, 0x00 },
      { 0x00, 0x14, 0x14, 0x00 },
      { 0x00, 0x00, 0x00, 0x00 },
    },
    {
      { 0x14, 0x00, 0x00, 0x00 },
      { 0x14, 0x14, 0x14, 0x00 },
      { 0x00, 0x00, 0x00, 0x00 },
      { 0x00, 0x00, 0x00, 0x00 },
    },
    {
      { 0x00, 0x14, 0x14, 0x00 },
      { 0x00, 0x14, 0x00, 0x00 },
      { 0x00, 0x14, 0x00, 0x00 },
      { 0x00, 0x00, 0x00, 0x00 },
    },
    {
      { 0x14, 0x14, 0x14, 0x00 },
      { 0x00, 0x00, 0x14, 0x00 },
      { 0x00, 0x00, 0x00, 0x00 },
      { 0x00, 0x00, 0x00, 0x00 },
    },
  },
  // half +
  {
    {
      { 0x00, 0x14, 0x00, 0x00 },
      { 0x00, 0x14, 0x14, 0x00 },
      { 0x00, 0x14, 0x00, 0x00 },
      { 0x00, 0x00, 0x00, 0x00 },
    },
    {
      { 0x00, 0x00, 0x00, 0x00 },
      { 0x14, 0x14, 0x14, 0x00 },
      { 0x00, 0x14, 0x00, 0x00 },
      { 0x00, 0x00, 0x00, 0x00 },
    },
    {
      { 0x00, 0x14, 0x00, 0x00 },
      { 0x14, 0x14, 0x00, 0x00 },
      { 0x00, 0x14, 0x00, 0x00 },
      { 0x00, 0x00, 0x00, 0x00 },
    },
    {
      { 0x00, 0x14, 0x00, 0x00 },
      { 0x14, 0x14, 0x14, 0x00 },
      { 0x00, 0x00, 0x00, 0x00 },
      { 0x00, 0x00, 0x00, 0x00 },
    },
  },
  // S
  {
    {
      { 0x00, 0x13, 0x00, 0x00 },
      { 0x00, 0x13, 0x13, 0x00 },
      { 0x00, 0x00, 0x13, 0x00 },
      { 0x00, 0x00, 0x00, 0x00 },
    },
    {
      { 0x00, 0x00, 0x00, 0x00 },
      { 0x00, 0x13, 0x13, 0x00 },
      { 0x13, 0x13, 0x00, 0x00 },
      { 0x00, 0x00, 0x00, 0x00 },
    },
    {
      { 0x00, 0x13, 0x00, 0x00 },
      { 0x00, 0x13, 0x13, 0x00 },
      { 0x00, 0x00, 0x13, 0x00 },
      { 0x00, 0x00, 0x00, 0x00 },
    },
    {
      { 0x00, 0x00, 0x00, 0x00 },
      { 0x00, 0x13, 0x13, 0x00 },
      { 0x13, 0x13, 0x00, 0x00 },
      { 0x00, 0x00, 0x00, 0x00 },
    },
  },
  // backward S
  {
    {
      { 0x00, 0x00, 0x12, 0x00 },
      { 0x00, 0x12, 0x12, 0x00 },
      { 0x00, 0x12, 0x00, 0x00 },
      { 0x00, 0x00, 0x00, 0x00 },
    },
    {
      { 0x00, 0x00, 0x12, 0x00 },
      { 0x00, 0x12, 0x12, 0x00 },
      { 0x00, 0x12, 0x00, 0x00 },
      { 0x00, 0x00, 0x00, 0x00 },
    },
    {
      { 0x00, 0x00, 0x12, 0x00 },
      { 0x00, 0x12, 0x12, 0x00 },
      { 0x00, 0x12, 0x00, 0x00 },
      { 0x00, 0x00, 0x00, 0x00 },
    },
    {
      { 0x00, 0x00, 0x12, 0x00 },
      { 0x00, 0x12, 0x12, 0x00 },
      { 0x00, 0x12, 0x00, 0x00 },
      { 0x00, 0x00, 0x00, 0x00 },
    }
  }
};
